<!--
Copyright (C) 2025 Dale Coghlan
SPDX-License-Identifier: AGPL-3.0-or-later

This program is free software: you can redistribute it and/or modify
it under the terms of the GNU Affero General Public License as published
by the Free Software Foundation, either version 3 of the License, or
(at your option) any later version.

This program is distributed in the hope that it will be useful,
but WITHOUT ANY WARRANTY; without even the implied warranty of
MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the
GNU Affero General Public License for more details.

You should have received a copy of the GNU Affero General Public License
along with this program. If not, see <https://www.gnu.org/licenses/>.

School Term At A Glance Generator for Google Sheets
https://github.com/dcoghlan/School-Term-At-A-Glance
-->

<!DOCTYPE html>
<html>
  <head>
    <base target="_top">
  </head>
  <body>
    <div id="loadingOverlay">
      <div class="spinner"></div>
      <div>Loading configuration...</div>
    </div>
    <style>
      body { 
        font-family: Arial, sans-serif; 
        margin: 0;
        padding: 0;
        height: 100vh;
        display: flex;
        flex-direction: column;
        overflow: hidden;
      }
      
      .content-wrapper {
        flex: 1;
        overflow-y: auto;
        padding: 20px;
        padding-bottom: 20px;
        position: relative;
      }
      
      .sticky-footer {
        position: sticky;
        bottom: 0;
        background: white;
        border-top: 2px solid #e0e0e0;
        padding: 15px 20px;
        box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
        z-index: 100;
      }
      
      .scroll-indicator {
        position: fixed;
        left: 50%;
        transform: translateX(-50%);
        background: rgba(66, 133, 244, 0.9);
        color: white;
        padding: 8px 16px;
        border-radius: 20px;
        font-size: 12px;
        pointer-events: none;
        opacity: 0;
        transition: opacity 0.3s ease;
        z-index: 99;
      }
      
      .scroll-indicator.visible {
        opacity: 1;
      }
      
      .scroll-indicator.top {
        top: 10px;
      }
      
      .scroll-indicator.bottom {
        bottom: 80px;
      }
      
      .form-group { margin-bottom: 15px; }
      label { display: block; margin-bottom: 5px; font-weight: bold; }
      input, select { width: 100%; padding: 8px; box-sizing: border-box; }
      button { background: #4285f4; color: white; border: none; padding: 10px 20px; 
               cursor: pointer; border-radius: 4px; margin-top: 10px; }
      button:hover { background: #3367d6; }
      button:disabled { background: #ccc; cursor: not-allowed; }

      /* New and modified CSS for inline checkbox */
      .help { 
          font-size: 12px; 
          color: #666; 
          margin: 0; /* Remove default margin */
      }
      .checkbox-container {
          display: flex; /* Use flexbox for horizontal alignment */
          align-items: center; /* Vertically center items */
          margin-bottom: 15px; /* Add margin back for spacing */
      }
      
      /* Targets ALL checkboxes inside a checkbox-container */
      .checkbox-container input[type="checkbox"] {
          width: auto; /* Allow checkbox to be its natural size */
          margin-right: 8px; /* Space between checkbox and text */
      }

      /* Styles for the collapsible Advanced section */
      details {
        border: 1px solid #e0e0e0;
        border-radius: 4px;
        padding: 10px;
        margin-bottom: 15px;
        background-color: #f9f9f9;
      }
      summary {
        cursor: pointer;
        font-weight: bold;
        color: #444;
        outline: none;
        margin-bottom: 15px; /* Added space specifically below the summary text */
      }
      summary:hover {
        color: #000;
      }
      /* Add spacing to the content inside details when expanded */
      details > div {
        margin-top: 10px;
        padding-left: 5px; /* Slight indent for hierarchy */
        border-top: 1px solid #eee; /* Separator line */
        padding-top: 20px; /* Increased padding to separate from the line */
      }

      .reset-link {
        font-size: 11px;
        color: #4285f4;
        text-decoration: underline;
        cursor: pointer;
        margin-left: 10px;
        user-select: none;
      }
      
      .reset-link:hover {
        color: #3367d6; /* Darker blue on hover */
      }

      /* Loading Overlay Styles */
      #loadingOverlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: #ffffff;
        z-index: 9999;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        color: #666;
        font-size: 14px;
      }

      .spinner {
        border: 4px solid #f3f3f3;
        border-top: 4px solid #4285f4; /* Google Blue */
        border-radius: 50%;
        width: 30px;
        height: 30px;
        animation: spin 1s linear infinite;
        margin-bottom: 10px;
      }

      @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
      }

      /* Calendar Block Styles */
      .calendars-container {
        margin-bottom: 20px;
      }

      .calendar-block {
        border: 2px solid #e0e0e0;
        border-radius: 8px;
        padding: 15px;
        margin-bottom: 15px;
        background-color: #fafafa;
        position: relative;
        cursor: move;
      }

      .calendar-block.dragging {
        opacity: 0.5;
        border-color: #4285f4;
      }

      .calendar-block.drag-over {
        border-color: #4285f4;
        border-style: dashed;
        background-color: #e8f0fe;
      }

      .calendar-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 0; /* Remove margin since summary handles spacing */
        padding-bottom: 10px;
        border-bottom: 1px solid #ddd;
      }

      .calendar-title {
        font-weight: bold;
        font-size: 14px;
        color: #333;
        display: flex;
        align-items: center;
      }
      
      /* Styles for collapsible calendar blocks */
      .calendar-block details {
        border: none; /* Remove border from details inside calendar-block */
        padding: 0;
        margin: 0;
        background-color: transparent;
      }
      
      .calendar-block summary {
        cursor: pointer;
        font-weight: normal; /* Keep normal weight since calendar-title is bold */
        color: inherit;
        outline: none;
        margin-bottom: 15px;
        list-style: none; /* Remove default arrow */
      }
      
      .calendar-block summary::-webkit-details-marker {
        display: none; /* Remove default arrow in WebKit browsers */
      }
      
      .calendar-block summary:hover {
        color: inherit;
      }
      
      .calendar-block details > div {
        margin-top: 0;
        padding-left: 0;
        border-top: none;
        padding-top: 0;
      }
      
      .calendar-term-name {
        color: #666;
        font-weight: normal;
        font-size: 0.9em;
        margin-left: 5px;
      }
      
      .collapse-indicator {
        margin-left: 8px;
        font-size: 12px;
        color: #666;
        transition: transform 0.2s ease;
        display: inline-block;
      }
      
      details[open] .collapse-indicator {
        transform: rotate(180deg);
      }

      .drag-handle {
        cursor: move;
        color: #999;
        margin-right: 10px;
        font-size: 18px;
      }

      .delete-calendar-btn {
        background: #d93025;
        color: white;
        border: none;
        padding: 5px 10px;
        cursor: pointer;
        border-radius: 4px;
        font-size: 12px;
      }

      .delete-calendar-btn:hover:not(:disabled) {
        background: #b71c1c;
      }

      .delete-calendar-btn:disabled {
        background: #ccc;
        cursor: not-allowed;
      }

      .add-calendar-container {
        text-align: center;
        margin-bottom: 20px;
      }

      .add-calendar-btn {
        background: #34a853;
        color: white;
        border: none;
        padding: 10px 20px;
        cursor: pointer;
        border-radius: 4px;
        font-size: 14px;
      }

      .add-calendar-btn:hover:not(:disabled) {
        background: #2d8e47;
      }

      .add-calendar-btn:disabled {
        background: #ccc;
        cursor: not-allowed;
      }

      .calendar-inputs {
        display: grid;
        gap: 10px;
      }

      .calendar-block input[type="text"],
      .calendar-block input[type="date"],
      .calendar-block input[type="number"] {
        width: 100%;
      }

      .color-input-container {
        display: flex;
        align-items: center;
        gap: 10px;
      }

      .color-input-container input[type="color"] {
        width: 60px;
        height: 40px;
        padding: 0;
        border: none;
        cursor: pointer;
      }
    </style>
    
    <!-- Scroll Indicators -->
    <div id="scrollIndicatorTop" class="scroll-indicator top">▲ Scroll up for more</div>
    <div id="scrollIndicatorBottom" class="scroll-indicator bottom">▼ Scroll down for more</div>
    
    <!-- Content Wrapper -->
    <div class="content-wrapper" id="contentWrapper">
      <!-- GLOBAL CONFIGURATION -->
      <h3 style="margin-top: 0;">Global Settings</h3>
    
    <div class="form-group">
      <label>Select Google Calendar:</label>
      <select id="calendarId">
        <option value="" disabled selected>Loading calendars...</option>
      </select>
      <div class="help">
        Select the calendar where events will be read from (applies to all calendars).
      </div>
    </div>

    <!-- CALENDARS SECTION -->
    <h3>Calendars</h3>
    <div class="help" style="margin-bottom: 15px;">
      Configure up to 9 calendars. Drag to reorder. Each calendar creates a separate sheet.
    </div>

    <div id="calendarsContainer" class="calendars-container">
      <!-- Calendar blocks will be inserted here dynamically -->
    </div>

    <div class="add-calendar-container">
      <button id="addCalendarBtn" class="add-calendar-btn" onclick="addCalendar()">+ Add Calendar</button>
    </div>

    <!-- ADVANCED CONFIGURATION (Collapsible) -->
    <details>
      <summary>Advanced Configuration</summary>
      <div>
        <div class="form-group">
          <label>New Event URL (Optional):</label>
          <input type="text" id="newEventUrl" placeholder="e.g. https://calendar.google.com/...">
          <div class="help">Adds a clickable "Add New Event" link below each calendar title.</div>
        </div>
        <!-- Stale Period -->
        <div class="form-group">
          <label>Stale data period:</label>
          <input type="text" id="stalePeriod" placeholder="Leave blank for default = 6">
          <div class="help">Period (hrs) for visual stale indicator</div>
        </div>

        <!-- Ignore Names -->
        <div class="form-group">
          <label>Ignore Event Titles:</label>
          <input type="text" id="ignoreNames" placeholder="e.g. Holiday, Staff Day">
          <div class="help">Comma-separated list of event titles to ignore</div>
        </div>

        <!-- Historical Shading -->
        <div class="form-group">
          <label>Historical events shading:</label>
        </div>
        <div class="checkbox-container">
          <input type="checkbox" id="historicalShading">
          <div class="help">Enable shading of historical events</div>
        </div>
        
        <!-- Hide Historical Weeks -->
        <div class="form-group">
          <label>Hide historical weeks:</label>
        </div>
        <div class="checkbox-container">
          <input type="checkbox" id="hideHistoricalWeeks">
          <div class="help">Collapse/hide historical weeks by default</div>
        </div>

        <!-- Display End Times -->
        <div class="form-group">
          <label>Display event end times:</label>
        </div>
        <div class="checkbox-container">
          <input type="checkbox" id="displayEndTimes">
          <div class="help">Display event end times for each event</div>
        </div>
      </div>
    </details>
    </div>
    
    <!-- Sticky Footer with Save Button -->
    <div class="sticky-footer">
      <button onclick="saveConfig()" style="width: 100%; margin: 0;">Save Configuration</button>
    </div>
    
    <script>
      const MAX_CALENDARS = 9;
      const MIN_CALENDARS = 1;
      let calendarCounter = 0;
      let draggedElement = null;

      // We need to chain the calls:
      // 1. Get the list of calendars and populate the dropdown.
      // 2. THEN get the saved config and set the values.
      // This prevents trying to set a value on the dropdown before the options exist.

      function loadForm() {
        google.script.run.withSuccessHandler(function(calendars) {
          const select = document.getElementById('calendarId');
          select.innerHTML = ''; // Clear 'Loading...' message

          // Add a default "Primary" option if desired, or just list what comes back
          calendars.forEach(function(cal) {
            const option = document.createElement('option');
            option.value = cal.id;
            // Display "Name (Primary)" if it is the primary calendar
            option.text = cal.name + (cal.isPrimary ? ' (Primary)' : '');
            select.appendChild(option);
          });

          // Now that options are loaded, fetch the saved config
          fetchConfig();
        }).withFailureHandler(function(error) {
          // Hide the loading overlay
          document.getElementById('loadingOverlay').style.display = 'none';
          
          // Display error message
          alert('Error loading calendars: ' + error.message);
          console.error('Failed to load calendars:', error);
        }).getUserCalendars();
      }

      function fetchConfig() {
        google.script.run.withSuccessHandler(function(config) {
          console.log('CLIENT: Successfully received config data:', config);
          
          // Set global settings
          if (config.historicalShading) document.getElementById('historicalShading').checked = config.historicalShading;
          if (config.stalePeriod) document.getElementById('stalePeriod').value = config.stalePeriod;
          if (config.hideHistoricalWeeks) document.getElementById('hideHistoricalWeeks').checked = config.hideHistoricalWeeks;
          if (config.displayEndTimes) document.getElementById('displayEndTimes').checked = config.displayEndTimes;
          if (config.newEventUrl) document.getElementById('newEventUrl').value = config.newEventUrl;

          // ignoreNames comes as an array from the server, we join it for the text box
          if (config.ignoreNames && Array.isArray(config.ignoreNames)) {
            document.getElementById('ignoreNames').value = config.ignoreNames.join(', ');
          }
          
          // Set the calendar dropdown
          if (config.calendarId) {
            const select = document.getElementById('calendarId');
            // Check if the saved ID actually exists in our list (user might have lost access)
            let exists = false;
            for(let i = 0; i < select.options.length; i++){
                if(select.options[i].value == config.calendarId){
                    exists = true;
                    break;
                }
            }
            // Set it if it exists, otherwise it defaults to the first in the list (usually Primary)
            if(exists) {
                select.value = config.calendarId;
            }
          }

          // Load calendars
          if (config.calendars && Array.isArray(config.calendars) && config.calendars.length > 0) {
            config.calendars.forEach(calendar => {
              addCalendar(calendar);
            });
          } else {
            // No calendars configured, add one default
            addCalendar();
          }

          // Once everything is set, hide the loading overlay
          document.getElementById('loadingOverlay').style.display = 'none';
          
          // Update scroll indicators after content is loaded
          setTimeout(updateScrollIndicators, 200);
        })
        .withFailureHandler(function(error) {
          // Hide the loading overlay
          document.getElementById('loadingOverlay').style.display = 'none';
          
          // Display error message
          alert('Error loading configuration: ' + error.message);
          console.error('Failed to load config:', error);
        })
        .getConfig();
      }

      function addCalendar(calendarData) {
        const container = document.getElementById('calendarsContainer');
        const calendarCount = container.children.length;

        if (calendarCount >= MAX_CALENDARS) {
          alert('Maximum of ' + MAX_CALENDARS + ' calendars allowed.');
          return;
        }

        calendarCounter++;
        const calendarId = 'calendar-' + calendarCounter;

        const calendarBlock = document.createElement('div');
        calendarBlock.className = 'calendar-block';
        calendarBlock.id = calendarId;

        // Add drag event listeners
        calendarBlock.addEventListener('dragover', handleDragOver);
        calendarBlock.addEventListener('drop', handleDrop);
        calendarBlock.addEventListener('dragenter', handleDragEnter);
        calendarBlock.addEventListener('dragleave', handleDragLeave);

        calendarBlock.innerHTML = `
          <details>
            <summary>
              <div class="calendar-header">
                <div class="calendar-title" draggable="true">
                  <span class="drag-handle">☰</span>
                  <span class="calendar-number">Calendar ${calendarCount + 1}</span>
                  <span class="calendar-term-name">${calendarData && calendarData.termName ? '(' + calendarData.termName + ')' : ''}</span>
                  <span class="collapse-indicator">▼</span>
                </div>
                <button class="delete-calendar-btn" onclick="deleteCalendar('${calendarId}'); event.stopPropagation();">Delete</button>
              </div>
            </summary>
            <div class="calendar-inputs">
              <div class="form-group">
                <label>Calendar Name:</label>
                <input type="text" class="termName" placeholder="e.g., Term 1 2025" value="${calendarData ? calendarData.termName || '' : ''}" onchange="updateCalendarTermName('${calendarId}')">
                <div class="help">Sheet name and title for this calendar.</div>
              </div>
              
              <div class="form-group">
                <label>Start Date:</label>
                <input type="date" class="startDate" value="${calendarData ? calendarData.startDate || '' : ''}">
              </div>

              <div class="form-group">
                <label>Number of Weeks:</label>
                <input type="number" class="weekCount" min="1" max="52" step="1" value="${calendarData ? calendarData.weekCount || 10 : 10}">
                <div class="help">Enter a duration between 1 and 52 weeks.</div>
              </div>

              <div class="form-group">
                <label>Week Header Color:</label>
                <div class="color-input-container">
                  <input type="color" class="weekHeaderColor" value="${calendarData ? calendarData.weekHeaderColor || '#4285f4' : '#4285f4'}">
                  <span class="reset-link" onclick="resetCalendarColor('${calendarId}')">Reset to default</span>
                </div>
                <div class="help">Background color for week headers.</div>
              </div>
            </div>
          </details>
        `;

        container.appendChild(calendarBlock);
        
        // Attach drag event listeners to the calendar title (which includes the drag handle)
        const calendarTitle = calendarBlock.querySelector('.calendar-title');
        calendarTitle.addEventListener('dragstart', handleDragStart);
        calendarTitle.addEventListener('dragend', handleDragEnd);
        
        // Prevent the summary from toggling when dragging
        calendarTitle.addEventListener('mousedown', function(e) {
          // Mark that we're potentially starting a drag
          calendarTitle.dataset.isDragging = 'true';
        });
        
        calendarTitle.addEventListener('click', function(e) {
          // If we were dragging, prevent the toggle
          if (calendarTitle.dataset.isDragging === 'true') {
            e.stopPropagation();
            e.preventDefault();
          }
          delete calendarTitle.dataset.isDragging;
        });
        
        updateCalendarControls();
      }

      function deleteCalendar(calendarId) {
        const container = document.getElementById('calendarsContainer');
        const calendarCount = container.children.length;

        if (calendarCount <= MIN_CALENDARS) {
          alert('At least one calendar must be configured.');
          return;
        }

        const calendarBlock = document.getElementById(calendarId);
        if (calendarBlock) {
          calendarBlock.remove();
          updateCalendarControls();
          updateCalendarNumbers();
        }
      }

      function resetCalendarColor(calendarId) {
        const calendarBlock = document.getElementById(calendarId);
        const colorInput = calendarBlock.querySelector('.weekHeaderColor');
        colorInput.value = '#4285f4';
      }

      function updateCalendarControls() {
        const container = document.getElementById('calendarsContainer');
        const calendarCount = container.children.length;
        const addBtn = document.getElementById('addCalendarBtn');

        // Update add button state
        addBtn.disabled = (calendarCount >= MAX_CALENDARS);

        // Update delete button states
        const deleteButtons = container.querySelectorAll('.delete-calendar-btn');
        deleteButtons.forEach(btn => {
          btn.disabled = (calendarCount <= MIN_CALENDARS);
        });
        
        // Update scroll indicators after content changes
        setTimeout(updateScrollIndicators, 100);
      }

      function updateCalendarNumbers() {
        const container = document.getElementById('calendarsContainer');
        const calendarBlocks = container.children;
        
        for (let i = 0; i < calendarBlocks.length; i++) {
          const numberSpan = calendarBlocks[i].querySelector('.calendar-number');
          const termNameSpan = calendarBlocks[i].querySelector('.calendar-term-name');
          const termNameInput = calendarBlocks[i].querySelector('.termName');
          
          numberSpan.textContent = 'Calendar ' + (i + 1);
          
          // Update term name display
          if (termNameInput && termNameInput.value) {
            termNameSpan.textContent = '(' + termNameInput.value + ')';
          } else {
            termNameSpan.textContent = '';
          }
        }
      }
      
      function updateCalendarTermName(calendarId) {
        const calendarBlock = document.getElementById(calendarId);
        const termNameInput = calendarBlock.querySelector('.termName');
        const termNameSpan = calendarBlock.querySelector('.calendar-term-name');
        
        if (termNameInput.value) {
          termNameSpan.textContent = '(' + termNameInput.value + ')';
        } else {
          termNameSpan.textContent = '';
        }
      }

      // Drag and Drop handlers
      function handleDragStart(e) {
        // 'this' is the calendar-title, but we want to drag the calendar-block
        draggedElement = this.closest('.calendar-block');
        draggedElement.classList.add('dragging');
        e.dataTransfer.effectAllowed = 'move';
        e.dataTransfer.setData('text/html', draggedElement.innerHTML);
        
        // Prevent the summary from toggling
        e.stopPropagation();
      }

      function handleDragOver(e) {
        if (e.preventDefault) {
          e.preventDefault();
        }
        e.dataTransfer.dropEffect = 'move';
        return false;
      }

      function handleDragEnter(e) {
        e.preventDefault();
        // 'this' is the calendar-block
        if (this !== draggedElement && this.classList.contains('calendar-block')) {
          this.classList.add('drag-over');
        }
      }

      function handleDragLeave(e) {
        // Only remove if we're actually leaving the calendar-block, not just entering a child
        if (e.target === this) {
          this.classList.remove('drag-over');
        }
      }

      function handleDrop(e) {
        if (e.preventDefault) {
          e.preventDefault();
        }
        if (e.stopPropagation) {
          e.stopPropagation();
        }

        // Remove all drag-over classes
        const allBlocks = document.querySelectorAll('.calendar-block');
        allBlocks.forEach(block => {
          block.classList.remove('drag-over');
        });

        // 'this' is the calendar-block being dropped onto
        if (draggedElement && draggedElement !== this) {
          const container = document.getElementById('calendarsContainer');
          const allBlocksArray = Array.from(container.children);
          const draggedIndex = allBlocksArray.indexOf(draggedElement);
          const targetIndex = allBlocksArray.indexOf(this);

          if (draggedIndex !== -1 && targetIndex !== -1) {
            if (draggedIndex < targetIndex) {
              container.insertBefore(draggedElement, this.nextSibling);
            } else {
              container.insertBefore(draggedElement, this);
            }

            updateCalendarNumbers();
          }
        }

        return false;
      }

      function handleDragEnd(e) {
        // 'this' is the calendar-title
        const calendarBlock = this.closest('.calendar-block');
        if (calendarBlock) {
          calendarBlock.classList.remove('dragging');
        }
        
        const allBlocks = document.querySelectorAll('.calendar-block');
        allBlocks.forEach(block => {
          block.classList.remove('drag-over');
        });
      }

      // Scroll indicator management
      function updateScrollIndicators() {
        const wrapper = document.getElementById('contentWrapper');
        const topIndicator = document.getElementById('scrollIndicatorTop');
        const bottomIndicator = document.getElementById('scrollIndicatorBottom');
        
        const scrollTop = wrapper.scrollTop;
        const scrollHeight = wrapper.scrollHeight;
        const clientHeight = wrapper.clientHeight;
        const scrollBottom = scrollHeight - scrollTop - clientHeight;
        
        // Show top indicator if scrolled down more than 50px
        if (scrollTop > 50) {
          topIndicator.classList.add('visible');
        } else {
          topIndicator.classList.remove('visible');
        }
        
        // Show bottom indicator if there's more than 50px to scroll
        if (scrollBottom > 50) {
          bottomIndicator.classList.add('visible');
        } else {
          bottomIndicator.classList.remove('visible');
        }
      }
      
      // Attach scroll listener
      document.getElementById('contentWrapper').addEventListener('scroll', updateScrollIndicators);
      
      // Initial check after a short delay to allow content to render
      setTimeout(updateScrollIndicators, 100);
      
      // Start the loading process
      loadForm();
      
      function saveConfig() {
        const container = document.getElementById('calendarsContainer');
        const calendarBlocks = container.children;

        if (calendarBlocks.length === 0) {
          alert('At least one calendar must be configured.');
          return;
        }

        // Collect all calendars
        const calendars = [];
        for (let i = 0; i < calendarBlocks.length; i++) {
          const block = calendarBlocks[i];
          const termName = block.querySelector('.termName').value.trim();
          const startDate = block.querySelector('.startDate').value;
          const weekCount = parseInt(block.querySelector('.weekCount').value, 10);
          const weekHeaderColor = block.querySelector('.weekHeaderColor').value;

          // Validate required fields
          if (!termName) {
            alert('Calendar ' + (i + 1) + ': Term Name is required.');
            return;
          }
          if (!startDate) {
            alert('Calendar ' + (i + 1) + ': Start Date is required.');
            return;
          }
          if (isNaN(weekCount) || weekCount < 1 || weekCount > 52) {
            alert('Calendar ' + (i + 1) + ': Number of weeks must be between 1 and 52.');
            return;
          }

          calendars.push({
            termName: termName,
            startDate: startDate,
            weekCount: weekCount,
            weekHeaderColor: weekHeaderColor
          });
        }

        // Convert ignoreNames comma-string back to array for the server
        const ignoreNamesRaw = document.getElementById('ignoreNames').value;
        const ignoreNamesArray = ignoreNamesRaw.split(',').map(s => s.trim()).filter(s => s !== '');

        const config = {
          calendarId: document.getElementById('calendarId').value,
          historicalShading: document.getElementById('historicalShading').checked,
          stalePeriod: document.getElementById('stalePeriod').value,
          hideHistoricalWeeks: document.getElementById('hideHistoricalWeeks').checked,
          displayEndTimes: document.getElementById('displayEndTimes').checked,
          newEventUrl: document.getElementById('newEventUrl').value,
          ignoreNames: ignoreNamesArray,
          calendars: calendars
        };
        console.log('CLIENT: Submitting config: ', config);
        
        // Show the loading overlay again so the user knows work is happening
        // Since generateCalendar takes time, this prevents them from clicking twice
        document.getElementById('loadingOverlay').style.display = 'flex';
        // Update the loading text (targeting the div inside the overlay)
        document.querySelector('#loadingOverlay > div:last-child').innerText = 'Saving & Generating Calendars...';

        google.script.run
          .withSuccessHandler(function() {
            // Close the modal once the server returns (which means calendar is done)
            google.script.host.close();
          })
          .withFailureHandler(function(err) {
            // If something goes wrong, hide loader and alert user
            document.getElementById('loadingOverlay').style.display = 'none';
            alert("Error: " + err.message);
          })
          .saveConfig(config);
      }
    </script>
  </body>
</html>
