<!--
Copyright (C) 2025 Dale Coghlan
SPDX-License-Identifier: AGPL-3.0-or-later

This program is free software: you can redistribute it and/or modify
it under the terms of the GNU Affero General Public License as published
by the Free Software Foundation, either version 3 of the License, or
(at your option) any later version.

This program is distributed in the hope that it will be useful,
but WITHOUT ANY WARRANTY; without even the implied warranty of
MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the
GNU Affero General Public License for more details.

You should have received a copy of the GNU Affero General Public License
along with this program. If not, see <https://www.gnu.org/licenses/>.

School Term At A Glance Generator for Google Sheets
https://github.com/dcoghlan/School-Term-At-A-Glance
-->

<!DOCTYPE html>
<html>
  <head>
    <base target="_top">
  </head>
  <body>
    <div id="loadingOverlay">
      <div class="spinner"></div>
      <div>Loading configuration...</div>
    </div>
    <style>
      body { font-family: Arial, sans-serif; padding: 20px; }
      .form-group { margin-bottom: 15px; }
      label { display: block; margin-bottom: 5px; font-weight: bold; }
      input, select { width: 100%; padding: 8px; box-sizing: border-box; }
      button { background: #4285f4; color: white; border: none; padding: 10px 20px; 
               cursor: pointer; border-radius: 4px; margin-top: 10px; }
      button:hover { background: #3367d6; }

      /* New and modified CSS for inline checkbox */
      .help { 
          font-size: 12px; 
          color: #666; 
          margin: 0; /* Remove default margin */
      }
      .checkbox-container {
          display: flex; /* Use flexbox for horizontal alignment */
          align-items: center; /* Vertically center items */
          margin-bottom: 15px; /* Add margin back for spacing */
      }
      
      /* Targets ALL checkboxes inside a checkbox-container */
      .checkbox-container input[type="checkbox"] {
          width: auto; /* Allow checkbox to be its natural size */
          margin-right: 8px; /* Space between checkbox and text */
      }

      /* Styles for the collapsible Advanced section */
      details {
        border: 1px solid #e0e0e0;
        border-radius: 4px;
        padding: 10px;
        margin-bottom: 15px;
        background-color: #f9f9f9;
      }
      summary {
        cursor: pointer;
        font-weight: bold;
        color: #444;
        outline: none;
        margin-bottom: 15px; /* Added space specifically below the summary text */
      }
      summary:hover {
        color: #000;
      }
      /* Add spacing to the content inside details when expanded */
      details > div {
        margin-top: 10px;
        padding-left: 5px; /* Slight indent for hierarchy */
        border-top: 1px solid #eee; /* Separator line */
        padding-top: 20px; /* Increased padding to separate from the line */
      }

      .reset-link {
        font-size: 11px;
        color: #4285f4;
        text-decoration: underline;
        cursor: pointer;
        margin-left: 10px;
        user-select: none;
      }
      
      .reset-link:hover {
        color: #3367d6; /* Darker blue on hover */
      }

      /* Loading Overlay Styles */
      #loadingOverlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: #ffffff;
        z-index: 9999;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        color: #666;
        font-size: 14px;
      }

      .spinner {
        border: 4px solid #f3f3f3;
        border-top: 4px solid #4285f4; /* Google Blue */
        border-radius: 50%;
        width: 30px;
        height: 30px;
        animation: spin 1s linear infinite;
        margin-bottom: 10px;
      }

      @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
      }
    </style>
    
    <!-- MAIN CONFIGURATION -->
    <div class="form-group">
      <label>Term Name:</label>
      <input type="text" id="termName" placeholder="e.g., Term 1 2025"></input>
    </div>
    
    <div class="form-group">
      <label>Start Date:</label>
      <input type="date" id="startDate">
    </div>

    <div class="form-group">
      <label>Number of Weeks:</label>
      <!-- type="number" triggers numeric keypads on mobile -->
      <!-- min/max sets the limits -->
      <!-- step="1" helps enforce integers (prevents decimals) -->
      <input type="number" id="weekCount" min="1" max="52" step="1" value="10">
      <div class="help">Enter a duration between 1 and 52 weeks.</div>
    </div>

    <div class="form-group">
      <label>Select Google Calendar:</label>
      <select id="calendarId">
        <option value="" disabled selected>Loading calendars...</option>
      </select>
      <div class="help">
        Select the calendar where events will be created.
      </div>
    </div>

    <!-- ADVANCED CONFIGURATION (Collapsible) -->
    <details>
      <summary>Advanced Configuration</summary>
      <div>
        <div class="form-group">
          <label>New Event URL (Optional):</label>
          <input type="text" id="newEventUrl" placeholder="e.g. https://calendar.google.com/...">
          <div class="help">Adds a clickable "Add New Event" link below the title.</div>
        </div>
        <!-- Stale Period -->
        <div class="form-group">
          <label>Stale data period:</label>
          <input type="text" id="stalePeriod" placeholder="Leave blank for default = 6">
          <div class="help">Period (hrs) for visual stale indicator</div>
        </div>

        <!-- Ignore Names -->
        <div class="form-group">
          <label>Ignore Event Titles:</label>
          <input type="text" id="ignoreNames" placeholder="e.g. Holiday, Staff Day">
          <div class="help">Comma-separated list of event titles to ignore</div>
        </div>

        <!-- Historical Shading -->
        <div class="form-group">
          <label>Historical events shading:</label>
        </div>
        <div class="checkbox-container">
          <input type="checkbox" id="historicalShading">
          <div class="help">Enable shading of historical events</div>
        </div>
        
        <!-- Hide Historical Weeks -->
        <div class="form-group">
          <label>Hide historical weeks:</label>
        </div>
        <div class="checkbox-container">
          <input type="checkbox" id="hideHistoricalWeeks">
          <div class="help">Collapse/hide historical weeks by default</div>
        </div>

        <div class="form-group">
          <label>Week Header Color:</label>
        </div>
        <div class="checkbox-container">
          <input type="color" id="weekHeaderColor" value="#4285f4"
            style="height:40px; width:60px; padding:0; border:none; cursor:pointer;">
        
          <span class="reset-link" onclick="resetColor()">Reset to default</span>
        </div>
        <div class="help" style="margin-bottom: 15px;">Select background color for week headers</div>

        <!-- Display End Times -->
        <div class="form-group">
          <label>Display event end times:</label>
        </div>
        <div class="checkbox-container">
          <input type="checkbox" id="displayEndTimes">
          <div class="help">Display event end times for each event</div>
        </div>
      </div>
    </details>

    <button onclick="saveConfig()">Save Configuration</button>
    
    <script>
      // We need to chain the calls:
      // 1. Get the list of calendars and populate the dropdown.
      // 2. THEN get the saved config and set the values.
      // This prevents trying to set a value on the dropdown before the options exist.

      function loadForm() {
        google.script.run.withSuccessHandler(function(calendars) {
          const select = document.getElementById('calendarId');
          select.innerHTML = ''; // Clear 'Loading...' message

          // Add a default "Primary" option if desired, or just list what comes back
          calendars.forEach(function(cal) {
            const option = document.createElement('option');
            option.value = cal.id;
            // Display "Name (Primary)" if it is the primary calendar
            option.text = cal.name + (cal.isPrimary ? ' (Primary)' : '');
            select.appendChild(option);
          });

          // Now that options are loaded, fetch the saved config
          fetchConfig();
        }).withFailureHandler(function(error) {
          // Hide the loading overlay
          document.getElementById('loadingOverlay').style.display = 'none';
          
          // Display error message
          alert('Error loading calendars: ' + error.message);
          console.error('Failed to load calendars:', error);
        }).getUserCalendars();
      }

      function fetchConfig() {
        google.script.run.withSuccessHandler(function(config) {
          console.log('CLIENT: Successfully received config data:', config);
          
          if (config.termName) document.getElementById('termName').value = config.termName;
          if (config.startDate) document.getElementById('startDate').value = config.startDate;
          if (config.weekCount) document.getElementById('weekCount').value = config.weekCount;
          if (config.historicalShading) document.getElementById('historicalShading').checked = config.historicalShading;
          if (config.stalePeriod) document.getElementById('stalePeriod').value = config.stalePeriod;
          if (config.hideHistoricalWeeks) document.getElementById('hideHistoricalWeeks').checked = config.hideHistoricalWeeks;
          if (config.displayEndTimes) document.getElementById('displayEndTimes').checked = config.displayEndTimes;
          if (config.newEventUrl) document.getElementById('newEventUrl').value = config.newEventUrl;

          if (config.weekHeaderColor) {
            document.getElementById('weekHeaderColor').value = config.weekHeaderColor;
          }

          // ignoreNames comes as an array from the server, we join it for the text box
          if (config.ignoreNames && Array.isArray(config.ignoreNames)) {
            document.getElementById('ignoreNames').value = config.ignoreNames.join(', ');
          }
          
          // Set the calendar dropdown
          if (config.calendarId) {
            const select = document.getElementById('calendarId');
            // Check if the saved ID actually exists in our list (user might have lost access)
            let exists = false;
            for(let i = 0; i < select.options.length; i++){
                if(select.options[i].value == config.calendarId){
                    exists = true;
                    break;
                }
            }
            // Set it if it exists, otherwise it defaults to the first in the list (usually Primary)
            if(exists) {
                select.value = config.calendarId;
            }
          }

          // Once everything is set, hide the loading overlay
          document.getElementById('loadingOverlay').style.display = 'none';
        })
        .withFailureHandler(function(error) {
          // Hide the loading overlay
          document.getElementById('loadingOverlay').style.display = 'none';
          
          // Display error message
          alert('Error loading configuration: ' + error.message);
          console.error('Failed to load config:', error);
        })
        .getConfig();
      }

      function resetColor() {
        // Sets the color picker back to the default Google Blue
        const defaultColor = '#4285f4';
        document.getElementById('weekHeaderColor').value = defaultColor;
      }

      // Start the loading process
      loadForm();
      
      function saveConfig() {
        // 1. Validate Number of Weeks
        const weekInput = document.getElementById('weekCount');
        const weekVal = parseInt(weekInput.value, 10);

        if (isNaN(weekVal) || weekVal < 1 || weekVal > 52) {
          alert("Please enter a number of weeks between 1 and 52.");
          return;
        }

        // 2. Convert ignoreNames comma-string back to array for the server
        const ignoreNamesRaw = document.getElementById('ignoreNames').value;
        const ignoreNamesArray = ignoreNamesRaw.split(',').map(s => s.trim()).filter(s => s !== '');

        const config = {
          termName: document.getElementById('termName').value,
          startDate: document.getElementById('startDate').value,
          weekCount: weekVal, // Use the parsed integer
          calendarId: document.getElementById('calendarId').value,
          historicalShading: document.getElementById('historicalShading').checked,
          stalePeriod: document.getElementById('stalePeriod').value,
          hideHistoricalWeeks: document.getElementById('hideHistoricalWeeks').checked,
          displayEndTimes: document.getElementById('displayEndTimes').checked,
          weekHeaderColor: document.getElementById('weekHeaderColor').value,
          newEventUrl: document.getElementById('newEventUrl').value,
          ignoreNames: ignoreNamesArray
        };
        console.log('CLIENT: Submitting config: ', config);
        
        // Show the loading overlay again so the user knows work is happening
        // Since generateCalendar takes time, this prevents them from clicking twice
        document.getElementById('loadingOverlay').style.display = 'flex';
        // Update the loading text (targeting the div inside the overlay)
        document.querySelector('#loadingOverlay > div:last-child').innerText = 'Saving & Generating Calendar...';

        google.script.run
          .withSuccessHandler(function() {
            // Close the modal once the server returns (which means calendar is done)
            google.script.host.close();
          })
          .withFailureHandler(function(err) {
            // If something goes wrong, hide loader and alert user
            document.getElementById('loadingOverlay').style.display = 'none';
            alert("Error: " + err.message);
          })
          .saveConfig(config);
      }
    </script>
  </body>
</html>